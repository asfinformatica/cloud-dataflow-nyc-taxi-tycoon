<!--
 Copyright 2016 Google Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<!--
This visualiser polls PubSub for new data points concurrently.
If PubSub acks are late and PubSub starts resending the same points
the visualiser will detect it and start outputting warnings in console.log
It is however  hard to overload. More likely, if too much processing is going on,
both the map update rate and the effective PubSub poll rate will drop and PubSub
will accumulate a backlog.
-->
<html>

<head>
    <meta charset="UTF-8">
    <title>NYC Taxi Tycoon - Dataflow Codelab Visualizer</title>
    <link rel="stylesheet" href="style.css" />
    <!-- utility class declarations -->
    <script src="slidingset.js"></script>

    <!-- configuration and global variables -->
    <script src="config.js"></script>
    <script src="globals.js"></script>

    <!-- angular js minified -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>

    <!-- Google API scripts -->
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9XzU603Rq1-FJkQ62jrxwvPstXCMEWhY&libraries=visualization,geometry&callback=initMap"></script>
    <script defer src="https://apis.google.com/js/api.js?onload=handleClientLoad"></script>
    <script src="googleapiaccess.js"></script>

    <!-- application scripts, need DOM ready -->
    <script defer src="dashboard.js"></script>
    <script defer src="datastatus.js"></script>
    <script defer src="clock.js"></script>
    <script defer src="recurrenttasks.js"></script>
    <script defer src="taxiridesfeed.js"></script>

    <!--
        TODO: implements a time-based refresh of the map, rather than the current refresh at each PubSub request
     -->
</head>

<body>

    <div id="container">
        <div id="dashboard" ng-app="TaxiRidesVisualizer" ng-controller="ProjectTopicsController">
            <div class="uiblock" id="pubsub">
                <div class="title">PubSub</div>

                <button id="authorize-button" ng-click="authorize()" style="display: none;">Authorize</button>
                <button id="authorize-button" ng-click="authorize()">Authorize</button>


                <button id="signout-button" ng-click="signout()" style="display: none;">Sign Out</button>
                <select id="project-selection" ng-model="selectedProject" ng-options="p.name for p in projects" ng-change="projectSelected()">
                    <option value="">Please select a project</option>
                </select>
                <select id="pubsub-topic-selection" ng-model="selectedTopic" ng-options="t.name for t in topics" ng-change="topicSelected()">
                    <option value="">Please select a topic</option>
                </select>
                <button id="start-fetching-button" ng-click="startFetching()">Start FetchingRides</button>
                <button id="stop-fetching-button" ng-click="stopFetching()">Stop Fetching Rides</button>
                <div class="msg" ng-bind="pubsub_status"></div>
            </div>
            <div class="uiblock">
                <div class="title">Data time</div>
                <div id="clock" onload="setNumbers">
                    <svg viewBox="-100 -100 200 200">
                        <rect id="date-rect" width="10.6ex" height="1.1em" x="-5.3ex" y="0.55em"></rect>
                        <text id="date-text" y="1.5em" text-anchor="middle">1970-01-01</text>
                        <line id="hourhand" x1="0" y1="0" x2="0" y2="-40" />
                        <line id="minutehand" x1="0" y1="0" x2="0" y2="-65" />
                        <line id="secondhand" x1="0" y1="0" x2="0" y2="-60" />
                        <circle id="clockcircle" r="80"/>
                        <circle id="handpin" r="3"/>
                    </svg>
                </div>
            </div>
            <div class="uiblock">
                <div class="title">Runrate ($/min)</div>
                <div id="dollar-display" class="dol">$0</div>
            </div>
            <div class="uiblock" id="exact-dollar-display-block">
                <div class="title">Exact turnover ($/min)</div>
                <div class="dol">
                    <div id="exact-dollar-display"></div>
                </div>
            </div>
            <div class="uiblock" id="missingdata-block">
                <div class="title">Running taxis</div>
                <canvas id="missingdata" width="200" height="200" style="width: 200px; height: 200px;"></canvas>
            </div>
            <div id="data-status" class="uiblock">
                <div class="flex-spacer"></div>
                <div class="msg"></div>
                <div class="flex-spacer"></div>
            </div>
        </div>
        <div id="map"></div>
    </div>
</body>

</html>

<script type="text/javascript">

// all button event handlers
var authorizeButton = document.getElementById('authorize-button');
var signoutButton = document.getElementById('signout-button');

var startFetchingRidesButton = document.getElementById('start-fetching-button');
var stopFetchingRidesButton = document.getElementById('stop-fetching-button');
var projectsSelect = document.getElementById('project-selection');
var topicsSelect = document.getElementById('pubsub-topic-selection');

// display for data overflow
var dataStatus = queryIfDisplayed('#data-status .msg');
var DATA_STATUS_ZERO = "Not receiving any data."
var DATA_STATUS_RATE = "Receiving %% data points/s."
var DATA_STATUS_RATE_OVERLOAD = "Overload: unable to read data fast enough (%% data points/s)."
var DATA_STATUS_RATE_SEVEREOVERLOAD = "Severe overload (%% data points/s). PubSub is re-sending."

function setDataStatus(msg, datarate) {
    if (dataStatus)
        dataStatus.innerHTML = msg.replace("%%", datarate)
}

function setDollarDisplay(amount) {
    var node = queryIfDisplayed("#dollar-display")
    if (node) {
        node.innerText = formatDollars(amount)
    }
}

function updateExactDollars(amount, id, timing) {
    var existing = queryIfDisplayed("#exact-dollar-display div#windowhash-" + id)
    if (existing) {
        setExactDollarNode(existing, amount, id, timing)
    } else {
        var node = queryIfDisplayed("#exact-dollar-display")
        if (node) {
            var newval = document.createElement("div")
            setExactDollarNode(newval, amount, id, timing)
            node.appendChild(newval)
            newval.scrollIntoView()
        }
    }
}

function setExactDollarNode(node, amount, id, timing) {
    //console.log("Dollar amount " + amount + " " + id + " " + timing)
    node.setAttribute("dolar-amount", amount) // save value
    node.setAttribute("id", "windowhash-" + id)
    var message = ""
    if (timing == "EARLY") {
        node.className = "incomplete"
        message = "(processing)"
    } else if (timing == "ON_TIME") {
        node.className = ""
    } else if (timing == "LATE") {
        node.className = "corrected"
        message = "(updated)"
    }
    node.innerText = message + " " + formatDollars(amount)
}

function queryIfDisplayed(id) {
    var e = document.querySelector(id)
    var visible = (e != null)
    var el = e
    while (el && el.tagName !== "BODY") {
        visible = visible && (getComputedStyle(el, null).display != 'none')
        el = el.parentNode
    }
    if (visible)
        return e
    else
        return null
}

function formatDollars(amount) {
    return amount.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 2 })
}

setDataStatus(DATA_STATUS_ZERO)

function setStartStopButton(val) {
    var signedin = auth2.isSignedIn.get()
    if (val == "start" && signedin) {
        startFetchingRidesButton.disabled = false;
        startFetchingRidesButton.style.display = 'block';
        stopFetchingRidesButton.style.display = 'none';
    }
    if (val == "stop" && signedin) {
        stopFetchingRidesButton.disabled = false;
        startFetchingRidesButton.style.display = 'none';
        stopFetchingRidesButton.style.display = 'block';
    }
    if (val == "disabled") {
        startFetchingRidesButton.disabled = true;
        stopFetchingRidesButton.disabled = true;
    }
    if (val == "hidden") {
        startFetchingRidesButton.style.display = 'none';
        stopFetchingRidesButton.style.display = 'none';
    }
}

function sortByName(o1, o2) {
    if ('name' in o1 && 'name' in o2) {
        if (o1.name.toLowerCase() > o2.name.toLowerCase()) return 1;
        if (o2.name.toLowerCase() > o1.name.toLowerCase()) return -1;
    } else if ('projectId' in o1 && 'projectId' in o2) {
        if (o1.projectId.toLowerCase() > o2.projectId.toLowerCase()) return 1;
        if (o2.projectId.toLowerCase() > o1.projectId.toLowerCase()) return -1;
    }
    return 0;
}

var app = angular.module('TaxiRidesVisualizer', []);
app.controller('ProjectTopicsController', function($scope, $timeout, projectsService, topicsService) {
    $scope.authorize = function() {
        auth2.signIn();
    };

    $scope.signout = function() {
        if (stopFetchingRidesButton.style.display == 'block') {
            $scope.stopFetching()
        };
        auth2.signOut();
        $scope.pubsub_status = "";
        setStartStopButton("hidden")
    };

    $scope.startFetching = function() {
        $scope.pubsub_status = "Creating PubSub subscription...";
        setStartStopButton("disabled")
        projectId = $scope.selectedProject.projectId
        topicId = $scope.selectedTopic.id
        createTopicPrFn = function(reason) {
            return pubsub.projects.subscriptions
                .create({
                    name: 'projects/' + projectId + '/subscriptions/' + PUBSUB_SUBSCRIPTION_NAME,
                    topic: topicId,
                    ackDeadlineSeconds: 120
                });
        };

        pubsub.projects.subscriptions
            .delete({ subscription: 'projects/' + projectId + '/subscriptions/' + PUBSUB_SUBSCRIPTION_NAME })
            .then(
                createTopicPrFn, createTopicPrFn
            ).then(
                function(response) {
                    if (auth2.isSignedIn.get()) {
                        PUBSUB_SUBSCRIPTION = response.result.name;
                        startPullingFromPubSub();
                        setStartStopButton("stop")
                            //$scope.pubsub_status = "Fetching rides...";
                        $scope.pubsub_status = "";
                        $scope.$apply();
                    }
                }
            );
    };

    $scope.stopFetching = function() {
        $scope.pubsub_status = "Deleting PubSub subscription...";
        setStartStopButton("disabled")
        stopPullingFromPubSub()
        clearStatusFn = function(resp) {
            $scope.pubsub_status = '';
            setStartStopButton("start")
            $scope.$apply();
        };
        pubsub.projects.subscriptions
            .delete({ subscription: 'projects/' + projectId + '/subscriptions/' + PUBSUB_SUBSCRIPTION_NAME })
            .then(clearStatusFn, clearStatusFn);
    };

    $scope.loadProjects = function() {
        $scope.pubsub_status = 'Checking authentication...';
        authPromise.then(function() {
            if (auth2.isSignedIn.get()) {
                $scope.pubsub_status = 'Loading projects...';
            } else {
                $scope.pubsub_status = '';
            }
            $scope.$apply();
        }).then(projectsService.getProjects).then(function(projects) {
            $scope.projects = projects.sort(sortByName);
            projectsSelect.style.display = 'block';
            $scope.pubsub_status = '';
            $scope.$apply();
        });
    };
    $scope.projectSelected = function() {
        $scope.loadTopics();
    };

    $scope.loadTopics = function() {
        if ($scope.selectedProject != null) {
            $scope.pubsub_status = 'Loading topics...';

            topicsService.getTopics($scope.selectedProject.projectId).then(
                function(topics) {
                    // add public pubsub topic to subscribe to directly
                    topic = {
                        id: 'projects/pubsub-public-data/topics/taxirides-realtime',
                        name: "## public taxirides-realtime topic ##"
                    }
                    topics.push(topic)
                    $scope.topics = topics.sort(sortByName);
                    if (topics.length > 0) {
                        topicsSelect.style.display = 'block';
                        $scope.pubsub_status = '';
                    } else {
                        topicsSelect.style.display = 'none';
                        $scope.pubsub_status = 'No topics found in this project';
                    }
                }
            )
        }
    }

    $scope.topicSelected = function() {
        if ($scope.selectedTopic != null)
            setStartStopButton("start")
    };
});

app.factory('projectsService', function($q) {
    return {
        getProjects: function() {
            var deferred = $q.defer();
            projects = []
            authPromise.then(function() {
                if (auth2.isSignedIn.get()) {
                    function fetchProjects(nextPageToken) {
                        var request = crm.projects.list({ pageSize: 1000, pageToken: nextPageToken })
                        request.execute(function(resp) {
                            resp.projects.forEach(function(p) {
                                if (p.lifecycleState === "ACTIVE") {
                                    projects.push(p)
                                }
                            });
                            if (resp.nextPageToken) {
                                fetchProjects(resp.nextPageToken)
                            } else {
                                console.log("Loaded " + projects.length + " project(s)")
                                deferred.resolve(projects)
                            }
                        })
                    }
                    fetchProjects('')
                }
            })
            return deferred.promise;
        }
    }
});

app.factory('topicsService', function($q) {
    return {
        getTopics: function(projectId) {
            var deferred = $q.defer();
            authPromise.then(function() {
                if (auth2.isSignedIn.get()) {
                    var request = pubsub.projects.topics.list({ project: 'projects/' + projectId, pageSize: 1000 })
                    request.execute(function(resp) {
                        topics = []
                        if ('topics' in resp) {
                            resp.topics.forEach(function(element) {
                                topics.push({ name: element.name.substring(element.name.lastIndexOf("/") + 1), id: element.name })
                            });
                        }
                        deferred.resolve(topics)
                    })
                }
            })
            return deferred.promise;
        }
    }
});

</script>
